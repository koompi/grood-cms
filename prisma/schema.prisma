generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// Organization / Tenant
model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  description String?
  website     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  posts       Post[]
  products    Product[]
  pages       Page[]
  media       Media[]
  mediaFolders MediaFolder[]
  menus       Menu[]
  inquiries   Inquiry[]
  settings    Setting[]
  categories  Category[]
  tags        Tag[]
  productCategories ProductCategory[]
  invitations OrganizationInvitation[]
  memberships OrganizationMembership[]
  revisions   Revision[]
  activityLogs ActivityLog[]
  
  // Grood CMS relations
  ebikes      EBike[]
  accessories Accessory[]
  stores      Store[]
  groodTestimonials GroodTestimonial[]
  faqs        FAQ[]
  groodPages  GroodPage[]

  @@map("organizations")
}

// Organization Membership (for users with multiple orgs)
model OrganizationMembership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           Role         @default(USER)
  isDefault      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("organization_memberships")
}

// Organization Invitation
model OrganizationInvitation {
  id             String       @id @default(cuid())
  email          String
  organizationId String
  role           Role         @default(USER)
  token          String       @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([email, organizationId])
  @@map("organization_invitations")
}

// User Management
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          Role      @default(USER)
  bio           String?
  
  // Koompi OAuth Fields
  username      String?
  firstName     String?
  lastName      String?
  telegramId    Int?
  walletAddress String?
  
  // Multi-tenancy (current/default organization)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  posts         Post[]
  media         Media[]
  memberships   OrganizationMembership[]
  revisions     Revision[]
  activityLogs  ActivityLog[]

  @@map("users")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Content Management
model Post {
  id            String        @id @default(cuid())
  title         String
  slug          String
  content       Json          // Rich text content
  excerpt       String?
  status        PostStatus    @default(DRAFT)
  type          PostType      @default(POST)
  featuredImage String?
  seo           Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  publishedAt   DateTime?
  scheduledAt   DateTime?     // For scheduled publishing
  deletedAt     DateTime?     // For soft delete / trash

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations
  author        User          @relation(fields: [authorId], references: [id])
  authorId      String
  categories    PostCategory[]
  tags          PostTag[]
  media         Media[]

  @@unique([slug, organizationId])
  @@index([organizationId, deletedAt])
  @@map("posts")
}

model Category {
  id          String      @id @default(cuid())
  name        String
  slug        String
  description String?
  parent      Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  parentId    String?
  children    Category[]  @relation("CategoryHierarchy")
  posts       PostCategory[]

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([slug, organizationId])
  @@map("categories")
}

model Tag {
  id    String      @id @default(cuid())
  name  String
  slug  String
  posts PostTag[]

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([slug, organizationId])
  @@map("tags")
}

// Product Management
model Product {
  id                String            @id @default(cuid())
  name              String
  slug              String
  description       Json
  shortDescription  String?
  price             Float
  compareAtPrice    Float?
  sku               String
  trackInventory    Boolean           @default(true)
  inventory         Int               @default(0)
  status            ProductStatus     @default(ACTIVE)
  featured          Boolean           @default(false)
  featuredImage     String?
  gallery           Json              // Array of image URLs
  specifications    Json              // Product specs
  options           Json              // Variations like color, size
  seo               Json?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  scheduledAt       DateTime?         // For scheduled activation
  deletedAt         DateTime?         // For soft delete / trash

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations
  categories        CategoryProduct[]
  reviews           Review[]
  testimonials      Testimonial[]
  media             Media[]

  @@unique([slug, organizationId])
  @@unique([sku, organizationId])
  @@index([organizationId, deletedAt])
  @@map("products")
}

model ProductCategory {
  id          String            @id @default(cuid())
  name        String
  slug        String
  description String?
  image       String?
  products    CategoryProduct[]
  parent      ProductCategory?  @relation("ProductCategoryHierarchy", fields: [parentId], references: [id])
  parentId    String?
  children    ProductCategory[] @relation("ProductCategoryHierarchy")

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([slug, organizationId])
  @@map("product_categories")
}

model Review {
  id        String   @id @default(cuid())
  name      String
  email     String
  rating    Int
  title     String?
  content   String
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String

  @@map("reviews")
}

// Page Management
model Page {
  id          String     @id @default(cuid())
  title       String
  slug        String
  content     Json       // Rich text content
  status      PageStatus @default(DRAFT)
  template    String     @default("default") // homepage, about, contact, etc.
  seo         Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  publishedAt DateTime?
  scheduledAt DateTime?  // For scheduled publishing
  deletedAt   DateTime?  // For soft delete / trash

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([slug, organizationId])
  @@index([organizationId, deletedAt])
  @@map("pages")
}

// Media Folder Management
model MediaFolder {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Nested folders (self-referential)
  parentId    String?
  parent      MediaFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    MediaFolder[] @relation("FolderHierarchy")

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Relations
  media       Media[]

  @@unique([slug, parentId, organizationId])
  @@map("media_folders")
}

// Media Management
model Media {
  id          String   @id @default(cuid())
  filename    String
  originalName String?
  alt         String?
  caption     String?
  mimeType    String
  size        Int
  width       Int?
  height      Int?
  url         String   @unique
  thumbnailUrl String?
  blurDataUrl  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt @default(now())

  // Folder organization
  folderId    String?
  folder      MediaFolder? @relation(fields: [folderId], references: [id])

  // Multi-tenancy
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // Relations
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id])
  uploadedById String?
  posts        Post[]
  products     Product[]

  // Usage tracking - stored as JSON array of references
  // Format: [{ type: "post"|"page"|"product", id: string, field: string }]
  usageRefs    Json?

  @@index([organizationId, folderId])
  @@index([mimeType])
  @@map("media")
}

// Testimonials
model Testimonial {
  id        String   @id @default(cuid())
  name      String
  company   String?
  position  String?
  content   String
  rating    Int
  avatar    String?
  featured  Boolean  @default(false)
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  @@map("testimonials")
}

// Site Settings
model Setting {
  id        String   @id @default(cuid())
  key       String
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([key, organizationId])
  @@map("settings")
}

// Navigation Menus
model Menu {
  id        String     @id @default(cuid())
  name      String
  location  String     // header, footer, sidebar
  items     MenuItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([name, organizationId])
  @@map("menus")
}

model MenuItem {
  id        String     @id @default(cuid())
  label     String
  url       String
  target    String     @default("_self") // _self, _blank
  order     Int        @default(0)
  menuId    String
  menu      Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    MenuItem?  @relation("MenuItemHierarchy", fields: [parentId], references: [id])
  children  MenuItem[] @relation("MenuItemHierarchy")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("menu_items")
}

// Contact Inquiries
model Inquiry {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  status    InquiryStatus @default(NEW)
  readAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@map("inquiries")
}

// Junction Tables
model PostCategory {
  postId     String
  categoryId String

  post     Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([postId, categoryId])
  @@map("post_categories")
}

model PostTag {
  postId String
  tagId  String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tags")
}

model CategoryProduct {
  productId     String
  categoryId String

  product     Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  category ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@map("category_product_junction")
}

// =====================
// RBAC (Role-Based Access Control)
// =====================

// Permission defines a specific action on a resource
model Permission {
  id          String   @id @default(cuid())
  resource    String   // e.g., "posts", "pages", "products", "users", "settings"
  action      String   // e.g., "view", "create", "edit", "delete", "publish"
  description String?
  
  createdAt   DateTime @default(now())
  
  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

// RolePermission links roles to permissions
model RolePermission {
  id           String     @id @default(cuid())
  role         Role
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime   @default(now())

  @@unique([role, permissionId])
  @@map("role_permissions")
}

// Enums
enum Role {
  SUPER_ADMIN  // Full access, can manage other admins
  ADMIN        // Full access within organization
  EDITOR       // Can edit and publish content
  AUTHOR       // Can create and edit own content
  USER         // Read-only / basic access
}

enum PostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum PostType {
  POST
  PAGE
  PRODUCT
}

enum ProductStatus {
  ACTIVE
  DRAFT
  SCHEDULED
  ARCHIVED
  OUT_OF_STOCK
}

enum PageStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum InquiryStatus {
  NEW
  READ
  REPLIED
  CLOSED
}

// Revision History for Content Versioning
model Revision {
  id          String   @id @default(cuid())
  contentType String   // 'post', 'page', 'product'
  contentId   String   // ID of the content being versioned
  version     Int      // Version number
  title       String
  content     String?  // JSON or HTML content
  metadata    Json?    // Additional data (excerpt, SEO, etc.)
  createdAt   DateTime @default(now())
  
  // Who made this revision
  authorId    String?
  author      User?    @relation(fields: [authorId], references: [id])
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  @@unique([contentType, contentId, version])
  @@index([contentType, contentId])
  @@index([organizationId])
  @@map("revisions")
}

// Activity Log for tracking changes
model ActivityLog {
  id          String   @id @default(cuid())
  action      String   // 'create', 'update', 'delete', 'publish', 'duplicate', etc.
  entityType  String   // 'post', 'page', 'product', 'media', 'user', etc.
  entityId    String   // ID of the affected entity
  entityTitle String?  // Title/name for display (e.g., post title)
  details     Json?    // Additional details about the change
  ipAddress   String?  // User's IP address
  userAgent   String?  // Browser/client info
  createdAt   DateTime @default(now())
  
  // Who performed the action
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
  @@index([userId])
  @@map("activity_logs")
}

// =====================
// GROOD CMS MODELS
// =====================

// E-Bike Products
model EBike {
  id            String   @id @default(cuid())
  name          String
  slug          String
  tagline       String?
  shortDescription String? // Brief description for cards
  description   Json?    // Tiptap JSON
  price         Float
  originalPrice Float?   // For showing discounts
  heroImage     String?
  galleryImages Json?    // Array of image URLs
  colors        Json?    // [{name, hex, image}]
  specs         Json?    // {range, speed, weight, battery, motor, etc}
  features      Json?    // [{icon, title, description}]
  badge         String?  // "Best Seller", "New", etc
  status        EBikeStatus @default(DRAFT)
  order         Int      @default(0)
  
  // SEO
  seoTitle      String?
  seoDescription String?
  ogImage       String?
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([slug, organizationId])
  @@index([organizationId, status])
  @@map("ebikes")
}

// Accessories
model Accessory {
  id            String   @id @default(cuid())
  name          String
  slug          String
  description   Json?    // Tiptap JSON
  shortDesc     String?
  price         Float
  originalPrice Float?   // For showing discounts
  image         String?
  category      AccessoryCategory @default(OTHER)
  badge         String?  // "New", "Sale", etc
  rating        Float?
  reviewCount   Int      @default(0)
  inStock       Boolean  @default(true)
  status        AccessoryStatus @default(DRAFT)
  order         Int      @default(0)
  
  // SEO
  seoTitle      String?
  seoDescription String?
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([slug, organizationId])
  @@index([organizationId, category, status])
  @@map("accessories")
}

// Store Locations
model Store {
  id          String   @id @default(cuid())
  name        String
  type        StoreType @default(SERVICE_POINT)
  address     String
  city        String
  country     String
  phone       String?
  email       String?
  hours       String?  // e.g., "Mon-Fri: 9AM-6PM"
  services    Json?    // Array of service names
  image       String?
  lat         Float?
  lng         Float?
  status      StoreStatus @default(ACTIVE)
  featured    Boolean  @default(false)
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([organizationId, city, status])
  @@map("stores")
}

// Press Quotes & Customer Testimonials
model GroodTestimonial {
  id        String   @id @default(cuid())
  quote     String
  source    String   // "Tech Review Asia", "CNN", etc.
  author    String?  // Optional author name
  rating    Int?     // 1-5 stars (for customer reviews)
  type      TestimonialType @default(PRESS)
  featured  Boolean  @default(false)
  order     Int      @default(0)
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, type, featured])
  @@map("grood_testimonials")
}

// FAQs
model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String   // Can be HTML or plain text
  category  FAQCategory @default(GENERAL)
  order     Int      @default(0)
  published Boolean  @default(true)
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, category])
  @@map("faqs")
}

// Page Templates
model PageTemplate {
  id          String   @id @default(cuid())
  name        String   // "Homepage", "Product Listing", etc.
  slug        String   @unique
  description String?
  thumbnail   String?
  blocks      Json     // Default block structure
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  pages       GroodPage[]

  @@map("page_templates")
}

// Grood Pages (for block-based page building)
model GroodPage {
  id          String   @id @default(cuid())
  title       String
  slug        String
  blocks      Json     // Array of block configs
  
  // Template reference
  templateId  String?
  template    PageTemplate? @relation(fields: [templateId], references: [id])
  
  // SEO
  seoTitle      String?
  seoDescription String?
  ogImage       String?
  
  status      GroodPageStatus @default(DRAFT)
  publishedAt DateTime?
  
  // Multi-tenancy
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([slug, organizationId])
  @@index([organizationId, status])
  @@map("grood_pages")
}

// =====================
// GROOD ENUMS
// =====================

enum EBikeStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AccessoryCategory {
  SAFETY      // Helmets, lights, locks
  BAGS        // Panniers, baskets, bags
  COMFORT     // Seats, grips, mirrors
  TECH        // GPS, phone mounts, chargers
  MAINTENANCE // Tools, cleaning, parts
  OTHER
}

enum AccessoryStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum StoreType {
  BRAND_STORE    // Full brand store
  SERVICE_POINT  // Service/repair point
  DEALER         // Authorized dealer
}

enum StoreStatus {
  ACTIVE
  COMING_SOON
  CLOSED
}

enum TestimonialType {
  PRESS     // Press/media quotes
  CUSTOMER  // Customer reviews
}

enum FAQCategory {
  GENERAL
  SHIPPING
  WARRANTY
  PAYMENT
  TECHNICAL
  ORDERING
  RETURNS
}

enum GroodPageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}